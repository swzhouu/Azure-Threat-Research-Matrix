# AZT606.1 - Steal App Service Easy Auth Tokens: App Service Token File Decryption (Kudu)

An attacker with the ability to run commands in an App Service container or read environment variables can retrieve the Easy Auth token cache from the App Service filesystem and decrypt it using the application’s Easy Auth encryption key. Kudu (the App Service SCM site) exposes APIs such as `/api/command`, `/api/env`, and `/api/vfs` that facilitate command execution and file access when authenticated.

**Resource**  
App Service

**Permissions / Preconditions**

- Ability to access the App Service SCM/Kudu site with sufficient rights to execute commands or read files (commonly via a role such as **Contributor** on the App Service).
- Easy Auth enabled with the default filesystem token cache (or another accessible token store).
- Network access to the `{site}.scm.azurewebsites.net` endpoint (SCM site).

**Token Store Locations (default filesystem cache)**

- Linux: `/home/data/.auth/tokens`
- Windows: `C:\home\data\.auth\tokens`

**Key Material**

- `WEBSITE_AUTH_ENCRYPTION_KEY` — Easy Auth token encryption key stored as an app setting / environment variable.

**Procedure (High Level)**

1. Determine that Easy Auth is enabled on the target App Service.
2. Use the Kudu/SCM site to:
   - List/read environment variables to obtain `WEBSITE_AUTH_ENCRYPTION_KEY` (e.g., `GET https://{site}.scm.azurewebsites.net/api/env`).
   - Enumerate and read encrypted token JSON files from the token store directories (e.g., `GET https://{site}.scm.azurewebsites.net/api/vfs/home/data/.auth/tokens/`).
3. Decrypt the token cache entries using the application’s Easy Auth encryption key to recover user tokens (ID/access/refresh where present).
4. Use recovered tokens to access the application and/or downstream APIs as the victim user, within the tokens’ scopes and lifetimes.

**Examples**

- **Tooling**: NetSPI’s `Get-AzWebAppTokens` (part of MicroBurst) automates enumeration, Kudu interactions, token file collection, and decryption.
- **Indicative API paths** (SCM/Kudu):
  - `POST https://{site}.scm.azurewebsites.net/api/command`
  - `GET  https://{site}.scm.azurewebsites.net/api/env`
  - `GET  https://{site}.scm.azurewebsites.net/api/vfs/home/data/.auth/tokens/`

**Detections**

*Logs*

Data Source | Operation / Indicator | Action | Log Provider
---|---|---|---
SCM/Kudu HTTP | Requests to `{site}.scm.azurewebsites.net` with paths like `/api/command`, `/api/env`, `/api/vfs/.../.auth/tokens` | N/A | AppServiceHTTPLogs (Azure Monitor / Diagnostic Settings)
Azure Activity (context) | Configuration changes enabling diagnostics or starting/stopping the site | Microsoft.Web/* | AzureActivity

*Queries (KQL examples)*

- **Kudu command/file access (HTTP)**  
  Looks for SCM requests to command/env/VFS endpoints:
  ```kusto
  AppServiceHTTPLogs
  | where CsHost endswith ".scm.azurewebsites.net"
  | where CsUriStem has_any("/api/command", "/api/env", "/api/vfs")
  | project TimeGenerated, CsHost, CsMethod, CsUriStem, ScStatus, UserAgent, _ResourceId
  | order by TimeGenerated desc
  ```

- **Direct token-store browsing via VFS**  
  ```kusto
  AppServiceHTTPLogs
  | where CsHost endswith ".scm.azurewebsites.net"
  | where CsUriStem has "/api/vfs" and CsUriStem has "/.auth/tokens"
  | summarize count() by bin(TimeGenerated, 1h), CsHost
  ```

**Mitigations**

- **Restrict SCM/Kudu access**: Apply **Access Restrictions** specifically to the **advanced tools (scm) site** to limit who can reach Kudu (e.g., IP allow-lists, private endpoints, VNets).
- **Least privilege**: Avoid broad **Contributor** grants on App Services; prefer narrowly scoped roles and separate operational identities.
- **Protect token encryption key**: Treat `WEBSITE_AUTH_ENCRYPTION_KEY` as sensitive secret material; rotate it after suspected exposure.
- **Monitoring**: Enable AppServiceHTTPLogs to Log Analytics; alert on suspicious SCM paths (`/api/command`, `/api/env`, `/api/vfs/.../.auth/tokens`).

**Additional Resources**

- NetSPI: Automating Azure App Services Token Decryption — https://www.netspi.com/blog/technical-blog/cloud-pentesting/automating-azure-app-services-token-decryption/
- MicroBurst `Get-AzWebAppTokens` — https://github.com/NetSPI/MicroBurst/blob/master/Azure/Get-AzWebAppTokens.ps1
- Daze Security: Easy Auth token cache & decryption background — https://www.daze.one/blog/stealing-azure-app-service-easy-auth-tokens
- Microsoft Docs: Kudu / Azure App Service advanced tools — https://learn.microsoft.com/azure/app-service/resources-kudu
- Microsoft Docs: AppServiceHTTPLogs table — https://learn.microsoft.com/azure/azure-monitor/reference/tables/appservicehttplogs
- Microsoft Docs: App Service access restrictions (main & SCM) — https://learn.microsoft.com/azure/app-service/app-service-ip-restrictions
