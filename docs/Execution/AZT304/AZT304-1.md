# AZT304.1 - Hijack Azure Machine Learning Notebooks: Storage Account Notebook Overwrite

**Resource**  
Azure Machine Learning (workspace, compute), Azure Storage Account (Azure Files)

**Summary**

AML stores notebooks on an associated Storage Account (file share commonly exposed as **code**). AML Studio presents these files in the notebook UI. With write access to the Storage Account, an attacker can edit a target `.ipynb` and insert a malicious **code cell** (optionally hidden in UI metadata). When a user runs all cells or an automated pipeline executes, the injected code runs on the AML **compute instance/cluster** with that session’s privileges (user context and/or Managed Identity).

**Preconditions / Permissions**

- **Write access** to the AML workspace’s **Storage Account file share** that stores notebooks (e.g., Storage Account Contributor, File Data SMB Share Elevated Contributor, or possession of **account keys/SAS**).
- To pivot into AML credentials: **Write** on AML workspace (for listKeys on certain endpoints) or equivalent permissions as applicable in current service behavior.
- Target notebook is executed by a user or as part of a pipeline/schedule.

**Where Notebooks Live**

- AML workspace’s **backing Storage Account** (named similar to `<workspace><digits>`).  
- **Azure Files** share (commonly `code`) contains `.ipynb` notebooks and user files.

**Procedure (High Level)**

1. Identify the AML workspace’s associated **Storage Account** and its **Azure Files** share hosting notebooks (e.g., `code`).  
2. Obtain write access (RBAC on Storage, account keys via management/data plane, or existing credentials).  
3. **Edit** a target `.ipynb` in the file share: add a new code cell (e.g., `! whoami`, token collection, exfiltration). Mark it hidden via notebook metadata if desired.  
4. Wait for a user to click **Run all** or for an **automated pipeline** execution to process the notebook.  
5. Use outputs or an **exfiltration channel** (HTTP/DNS, or write to storage) to retrieve results.  
6. (Optional) Leverage notebook execution to obtain **Managed Identity** tokens from the compute (e.g., `az login --identity --username $DEFAULT_IDENTITY_CLIENT_ID && az account get-access-token`) and pivot to other resources.

**Related Tooling**

- **MicroBurst** `Get-AzMachineLearningCredentials` gathers AML workspace **datastore credentials** and default datastore keys via the management plane API (subject to current service permissions).

**Detections**

*Storage / Data Plane*

- **Azure Activity Log** for **Storage Accounts**: monitor `Microsoft.Storage/storageAccounts/listKeys/action` preceding notebook file modifications.  
- **Azure Files** (Diagnostic Settings): alert on **writes** to `.ipynb` in the notebook share (e.g., `code/`).

*AML Management Plane*

- **Azure Activity Log** for AML: monitor `Microsoft.MachineLearningServices/workspaces/listKeys/action` (workspace list secrets/keys).  
- Watch for API calls to AML **datastore** endpoints returning secrets/keys (names may vary; verify in your tenant’s diagnostics).

*Example query ideas* (pseudocode / KQL-style; adjust to your tables):

```text
// Storage account key listings
AzureActivity
| where OperationNameValue == "Microsoft.Storage/storageAccounts/listKeys/action"
| summarize count() by Caller, ResourceGroup, _ResourceId, bin(TimeGenerated, 1h)

// Azure Files writes to notebooks (requires Storage logging to Log Analytics)
StorageFileLogs
| where Uri endswith ".ipynb" and OperationName has_any ("PutRange","PutFile","SetProperties","Create")
| summarize writes=count() by AccountName, ShareName, Path, bin(TimeGenerated, 15m)
```

**Mitigations**

- **Least privilege**: restrict Storage Account write roles; avoid broad Contributor and key access.  
- **Key hygiene**: disable **account key** usage where possible; favor **RBAC** with Azure AD; rotate keys/SAS tokens.  
- **Network controls**: use **Private Endpoints**; limit who can reach Storage and AML compute; restrict egress from compute as appropriate.  
- **Process controls**: require **code review** for notebooks; disallow automated **Run all** without approvals; scan notebooks for unexpected hidden cells.  
- **Logging**: enable **Diagnostic Settings** on Storage (Azure Files) and AML; alert on **listKeys** and on notebook file writes.

**Additional Resources**

- NetSPI: *Hijacking Azure Machine Learning Notebooks (via Storage Accounts)* – https://www.netspi.com/blog/technical-blog/cloud-pentesting/hijacking-azure-machine-learning-notebooks/
- MicroBurst `Get-AzMachineLearningCredentials` – https://github.com/NetSPI/MicroBurst/blob/master/Az/Get-AzMachineLearningCredentials.ps1
- Microsoft Docs: *Run Jupyter notebooks in your workspace* – https://learn.microsoft.com/azure/machine-learning/how-to-run-jupyter-notebooks
- Microsoft Docs: *Manage roles in your workspace (RBAC)* – https://learn.microsoft.com/azure/machine-learning/how-to-assign-roles
- Microsoft Docs: *Set up authentication (SDK/CLI)* – https://learn.microsoft.com/azure/machine-learning/how-to-setup-authentication
